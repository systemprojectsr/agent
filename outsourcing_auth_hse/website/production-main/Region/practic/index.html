<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выбор региона</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключаем API Яндекс.Карт - НЕ ЗАБУДЬТЕ ЗАМЕНИТЬ КЛЮЧ! -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=ВАШ_API_КЛЮЧ&lang=ru_RU" type="text/javascript"></script>
    <style>
      /* Добавляем минимальную высоту для контейнера карты, чтобы он был виден до загрузки API */
      #map {
          min-height: 384px; /* Соответствует h-96 Tailwind */
      }
      #matrix-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1; /* Помещаем позади всего */
        opacity: 0.4; /* Сделаем светлую матрицу чуть заметнее */
      }
      /* Добавляем стили для белки */
      #ascii-squirrel {
          position: fixed;
          top: 15px;
          right: 15px;
          color: #6B462C; /* Коричневатый цвет */
          font-family: monospace;
          font-size: 14px; /* Чуть меньше */
          line-height: 1;
          white-space: pre;
          z-index: 10;
          background-color: rgba(255, 255, 255, 0.7); /* Полупрозрачный светлый фон */
          padding: 8px;
          border-radius: 6px;
          border: 1px solid rgba(0,0,0,0.1);
          text-shadow: none;
      }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-center min-h-screen py-10 px-4">
    <!-- Canvas для матрицы -->
    <canvas id="matrix-canvas"></canvas>

    <!-- Блок с формой выбора региона (возвращаем светлые тона) -->
    <div class="bg-white bg-opacity-90 backdrop-blur-sm p-8 rounded-lg shadow-xl w-full max-w-sm mb-8 z-10">
        <h1 class="text-2xl font-bold mb-6 text-center text-indigo-700">Выбор региона</h1>
        
        {% if current_region %}
            <p class="mb-4 text-center text-green-700">Текущий регион: <span class="font-semibold">{{ current_region.name }}</span></p>
        {% else %}
            <p class="mb-4 text-center text-red-700">Регион не выбран</p>
        {% endif %}

        <form action="/" method="post">
            <label for="region" class="block text-sm font-medium text-gray-700 mb-2">Выберите регион:</label>
            <select name="region_id" id="region" class="block w-full p-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <option value="">-- Выберите --</option>
                {% for region in regions %}
                    {# Добавляем selected если ID региона совпадает с текущим выбранным регионом #}
                    <option value="{{ region.id }}" {% if current_region and current_region.id == region.id %}selected{% endif %}>{{ region.name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="mt-6 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-indigo-500">
                Установить регион
            </button>
        </form>
        
        <form action="/reset" method="post" class="mt-4">
             <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-red-500">
                Сбросить регион
            </button>
        </form>
    </div>

    <!-- Контейнер для карты (возвращаем светлый фон, добавляем скругление и overflow) -->
    <div id="map" class="w-full max-w-3xl h-96 bg-gray-200 bg-opacity-90 backdrop-blur-sm rounded-2xl shadow-xl z-10 overflow-hidden"></div>

    <!-- Добавляем элемент для ASCII белки -->
    <pre id="ascii-squirrel"></pre>

    <script type="text/javascript">
        // API ключ - замените 'ВАШ_API_КЛЮЧ' на ваш реальный ключ
        // Можно получить бесплатно в Кабинете разработчика: https://developer.tech.yandex.ru/
        const YANDEX_API_KEY = 'ВАШ_API_КЛЮЧ'; // <-- ЗАМЕНИТЬ!

        ymaps.ready(initMap);

        function initMap() {
            // Определяем переменные для карты
            let mapCenter = [55.76, 37.64]; // Москва по умолчанию
            let mapZoom = 10;
            let placemarkCoords = null;
            let placemarkContent = '';

            // Пытаемся получить данные о текущем регионе из Jinja
            {% if current_region and current_region.coords %}
                mapCenter = {{ current_region.coords|tojson }};
                placemarkCoords = mapCenter; // Используем те же координаты для метки
                placemarkContent = {{ current_region.name|tojson }}; // Используем tojson для безопасного вывода строки в JS
                mapZoom = 10; // Можно установить другой зум для выбранного города
            {% endif %}

            // Создаем карту
            try {
                 const myMap = new ymaps.Map("map", {
                    center: mapCenter,
                    zoom: mapZoom,
                    controls: ['zoomControl', 'fullscreenControl', 'geolocationControl', 'typeSelector'] // Добавим контролы
                 });

                // Добавляем метку, если регион выбран
                if (placemarkCoords) {
                    const myPlacemark = new ymaps.Placemark(placemarkCoords, {
                        hintContent: placemarkContent, // Подсказка при наведении
                        balloonContent: placemarkContent // Содержимое балуна при клике
                    }, {
                        preset: 'islands#blueDotIconWithCaption' // Стиль метки
                    });
                    myMap.geoObjects.add(myPlacemark);
                    
                    // Открываем балун метки сразу (опционально)
                    // myPlacemark.balloon.open(); 
                }
                
                 // Добавляем обработчик ошибок API
                myMap.events.add('error', function (event) {
                    console.error('Ошибка Яндекс.Карт:', event.get('error'));
                    // Можно показать сообщение пользователю
                });

            } catch (error) {
                 console.error("Ошибка при инициализации Яндекс.Карты:", error);
                 // Показываем сообщение об ошибке в контейнере карты
                 const mapContainer = document.getElementById('map');
                 if (mapContainer) {
                     mapContainer.innerHTML = '<p class="text-red-600 text-center p-4">Не удалось загрузить карту. Проверьте API-ключ и подключение к интернету.</p>';
                     mapContainer.classList.remove('bg-gray-700'); // Убираем фон
                 }
            }
        }

        // --- Код для матрицы --- 
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
        const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const nums = '0123456789';
        const alphabet = katakana + latin + nums;

        const fontSizeMatrix = 16; // Отдельная переменная для размера шрифта матрицы
        const columns = Math.floor(canvas.width / fontSizeMatrix);
        const rainDrops = new Array(columns).fill(1);

        function drawMatrix() {
            // Полупрозрачный светлый фон для эффекта затухания
            ctx.fillStyle = 'rgba(255, 255, 255, 0.06)'; // Белый фон
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#555'; // Темно-серый цвет для букв
            ctx.font = fontSizeMatrix + 'px monospace';

            for (let i = 0; i < rainDrops.length; i++) {
                const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                const x = i * fontSizeMatrix;
                const y = rainDrops[i] * fontSizeMatrix;
                ctx.fillText(text, x, y);

                if (y > canvas.height && Math.random() > 0.975) {
                    rainDrops[i] = 0;
                }
                rainDrops[i]++;
            }
        }
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // Пересчет столбцов при ресайзе (можно раскомментировать, если нужно)
            // columns = Math.floor(canvas.width / fontSizeMatrix);
            // rainDrops = new Array(columns).fill(1);
        });

        const matrixInterval = setInterval(drawMatrix, 60); // Чуть медленнее

        // --- Код для ASCII белки ---
        const squirrelElement = document.getElementById('ascii-squirrel');
        const squirrelFrames = [
`  (\_/)
 (='.'=)
 (")_(")`, // Стоит
`  (\_/)
 (='.'=)∫
 (")(")_/`, // Начало прыжка
`  (\_/)∫
 ∫(='.'=)
 /_(")(")`, // В прыжке
`∫(\_/)
 (='.'=)
 (")_(")`, // Приземление
        ];
        let currentSquirrelFrameIndex = 0;

        function animateSquirrel() {
            if (squirrelElement) {
                squirrelElement.textContent = squirrelFrames[currentSquirrelFrameIndex];
                currentSquirrelFrameIndex = (currentSquirrelFrameIndex + 1) % squirrelFrames.length;
            }
        }

        // Анимируем белку с интервалом
        const squirrelInterval = setInterval(animateSquirrel, 350); // Скорость анимации белки

        // Очистка интервалов при уходе со страницы (хорошая практика)
        window.addEventListener('beforeunload', () => {
            clearInterval(matrixInterval);
            clearInterval(squirrelInterval);
        });

    </script>
</body>
</html> 